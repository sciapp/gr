stages:
- prebuild
- build
- test
- package
- sync
- deploy

tag-type-check:
  stage: prebuild
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/deploy
  only:
    - tags@Scientific-IT-Systems/gr
  script:
    - test `git cat-file -t $CI_COMMIT_TAG` = "tag"

code-style-check:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/$CI_JOB_NAME
  script:
  - set +e
  - for file in $(git diff $(git describe --tags --abbrev=0) HEAD --name-only --diff-filter=ACMR); do
      [[ "${file}" != 3rdparty* ]] && [[ "${file}" != apps* ]] || continue;
      [[ "${file}" =~ \.(c|cpp|cxx|m|h|hpp|hxx)$ ]] || continue;
      grep -vr $'\r' "${file}" >/dev/null || { echo "${file} must not contain carriage return as line endings."; exit 1; };
      file --mime "${file}" | grep "charset=us-ascii" >/dev/null || { echo "${file} must be encoded as ASCII text."; exit 1; };
      clang-format -verbose -style=file "${file}" > "${file}.formatted";
      if ! diff -q "${file}" "${file}.formatted"; then
        diff "${file}" "${file}.formatted";
        >&2 echo "The code style of file \"${file}\" does not follow the code style guideline of this project.";
        exit 1;
      fi;
      rm -f "${file}.formatted";
    done
  - for file in $(git diff $(git describe --tags --abbrev=0) HEAD --name-only --diff-filter=ACMR); do
      [[ "${file}" != 3rdparty* ]] && [[ "${file}" != apps* ]] || continue;
      [[ "${file}" =~ (^|/)CMakeLists.txt$ || "${file}" =~ \.cmake$ ]] || continue;
      grep -vr $'\r' "${file}" >/dev/null || { echo "${file} must not contain carriage return as line endings."; exit 1; };
      file --mime "${file}" | grep "charset=us-ascii" >/dev/null || { echo "${file} must be encoded as ASCII text."; exit 1; };
      echo "Formatting ${file}";
      cmake-format "${file}" > "${file}.formatted";
      if ! diff -q "${file}" "${file}.formatted"; then
        diff "${file}" "${file}.formatted";
        >&2 echo "The code style of file \"${file}\" does not follow the code style guideline of this project.";
        exit 1;
      fi;
      rm -f "${file}.formatted";
    done
  - exit 0

ubuntu-self-contained:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/$CI_JOB_NAME
  script:
  - wget https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-linux-x86_64.tar.gz
  - tar xf cmake-3.23.0-linux-x86_64.tar.gz
  - export CMAKE_CMD=`pwd`/cmake-3.23.0-linux-x86_64/bin/cmake
  - make self GRDIR=/usr/local/gr
  - mkdir artifacts
  - cp lib/gks/demo artifacts/gksdemo
  - cp lib/gks/qt/gksqt artifacts/gksqt
  - cp lib/grm/grplot/grplot artifacts/grplot
  - cp lib/grm/grplot/README.md artifacts/grplot.man.md
  - cp lib/gr/demo artifacts/grdemo
  - cp lib/gks/libGKS.so lib/gks/libGKS.a lib/gks/plugin/*.so lib/gr/libGR.so lib/gr/libGR.a lib/gr3/libGR3.so
       lib/gr3/libGR3platform.so lib/grm/libGRM.a lib/grm/libGRM.so lib/gr/qtgr/*.so artifacts/
  - cp -r lib/gks/fonts artifacts/
  - mkdir artifacts/include/
  - cp lib/gks/gks.h lib/gr/gr.h lib/gr3/gr3.h lib/grm/include/grm.h lib/gr/qtgr/grwidget.h artifacts/include/
  - cp -r lib/grm/include/grm artifacts/include/
  - mv artifacts artifacts-ubuntu2004
  artifacts:
    expire_in: 1 week
    paths:
    - artifacts-ubuntu2004/

ubuntu-cmake-self-contained:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/ubuntu-self-contained
  script:
    - wget https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-linux-x86_64.tar.gz
    - tar xf cmake-3.23.0-linux-x86_64.tar.gz
    - export CMAKE_CMD=`pwd`/cmake-3.23.0-linux-x86_64/bin/cmake
    - $CMAKE_CMD -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=${CI_PROJECT_DIR}/install -DGR_USE_BUNDLED_LIBRARIES=ON -DGR_BUILD_EXTRA_BUNDLED_LIBRARIES=ON -DGR_BUILD_DEMOS=ON
    - $CMAKE_CMD --build build
    - $CMAKE_CMD --install build
    - mv install artifacts-ubuntu2004-cmake
    - mv build/grm_test_public_api/grm_test_snoop/snoop ./grm_snoop
    - mv build/grm_test_public_api/grm_test_snoop/libc_rand.so ./
  artifacts:
    expire_in: 1 week
    paths:
      - artifacts-ubuntu2004-cmake/

ubuntu-cmake-self-contained-debug:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/ubuntu-self-contained
  script:
    - wget https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-linux-x86_64.tar.gz
    - tar xf cmake-3.23.0-linux-x86_64.tar.gz
    - export CMAKE_CMD=`pwd`/cmake-3.23.0-linux-x86_64/bin/cmake
    - $CMAKE_CMD -S . -B build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_INSTALL_PREFIX=${CI_PROJECT_DIR}/install -DGR_USE_BUNDLED_LIBRARIES=ON -DGR_BUILD_EXTRA_BUNDLED_LIBRARIES=ON -DGR_BUILD_DEMOS=ON
    - $CMAKE_CMD --build build
    - $CMAKE_CMD --install build
    - mv install artifacts-ubuntu2004-cmake
    - mv build/grm_test_public_api/grm_test_snoop/snoop ./grm_snoop
    - mv build/grm_test_public_api/grm_test_snoop/libc_rand.so ./
  artifacts:
    expire_in: 1 week
    paths:
      - artifacts-ubuntu2004-cmake/
      - grm_snoop
      - libc_rand.so

ubuntu-cmake-self-contained-test-c:
  stage: test
  image: iffregistry.fz-juelich.de/scientific-it-systems/gr-test/c-testing
  rules:
  - if: '$CI_MERGE_REQUEST_ID'
    when: never
  - if: '$CI_COMMIT_MESSAGE =~ /RebuildReferenceImages\([][ ?*_a-zA-Z0-9-]*\)/'
    when: never
  - if: '$GR_REBUILD_REFERENCE'
    when: never
  - when: on_success
  needs:
  - ubuntu-cmake-self-contained-debug
  script:
  - export GRDIR=`pwd`/artifacts-ubuntu2004-cmake/
  - export GRM_VALIDATE=yes
  - gr_test c `pwd`/test_result/
  artifacts:
    paths:
    - test_result/
    when: on_failure

ubuntu-cmake-self-contained-test-cpp:
  stage: test
  image: iffregistry.fz-juelich.de/scientific-it-systems/gr-test/cpp-testing
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
      when: never
    - if: '$CI_COMMIT_MESSAGE =~ /RebuildReferenceImages\([][ ?*_a-zA-Z0-9-]*\)/'
      when: never
    - if: '$GR_REBUILD_REFERENCE'
      when: never
    - when: on_success
  needs:
    - ubuntu-cmake-self-contained-debug
  script:
    - export GRDIR=`pwd`/artifacts-ubuntu2004-cmake/
    - export GRM_VALIDATE=yes
    - gr_test cpp `pwd`/test_result/
  artifacts:
    paths:
      - test_result/
    when: on_failure

ubuntu-cmake-self-contained-test-grplot:
  stage: test
  image: iffregistry.fz-juelich.de/scientific-it-systems/gr-test/grplot-testing
  rules:
  - if: '$CI_MERGE_REQUEST_ID'
    when: never
  - if: '$CI_COMMIT_MESSAGE =~ /RebuildReferenceImages\([][ ?*_a-zA-Z0-9-]*\)/'
    when: never
  - if: '$GR_REBUILD_REFERENCE'
    when: never
  - when: on_success
  needs:
  - ubuntu-cmake-self-contained-debug
  script:
  - export GRDIR=`pwd`/artifacts-ubuntu2004-cmake/
  - export GRM_VALIDATE=yes
  - export LD_LIBRARY_PATH=$GRDIR/lib
  - export PATH=$GRDIR/bin/:$PATH
  - xvfb-run --server-args="-screen 0, 1920x1080x24" gr_test grplot `pwd`/test_result/
  artifacts:
    paths:
    - test_result/
    when: on_failure

ubuntu-cmake-self-contained-rebuild-images-c:
  stage: test
  image: iffregistry.fz-juelich.de/scientific-it-systems/gr-test/c-testing:latest
  rules:
  - if: '$CI_MERGE_REQUEST_ID'
    when: never
  - if: '$CI_COMMIT_MESSAGE =~ /RebuildReferenceImages\([][ ?*_a-zA-Z0-9-]*\)/'
    when: on_success
  - if: '$GR_REBUILD_REFERENCE'
    when: on_success
  needs:
  - ubuntu-cmake-self-contained-debug
  script:
  - apt-get update && apt-get install -y python3-venv
  - export GRDIR=`pwd`/artifacts-ubuntu2004-cmake/

  - mkdir -p ~/.ssh
  - cat $SSH_KEY | base64 -d > ~/.ssh/id_rsa
  - mv $SSH_KNOWN_HOSTS ~/.ssh/known_hosts
  - chmod 600 ~/.ssh/id_rsa
  - python3 -m venv env && source env/bin/activate
  - git clone gitlab@iffgit.fz-juelich.de:scientific-it-systems/gr-test.git
  - pip install -e gr-test/
  - cd gr-test
  - git checkout -b update-files/job-$CI_JOB_ID

  - if [[ -z "$GR_REBUILD_REFERENCE" ]]; then
      export GR_REBUILD_REFERENCE=`echo $CI_COMMIT_MESSAGE | sed 's/.*RebuildReferenceImages(\([][ ?*_a-zA-Z0-9-]*\)).*/\1/'` ;
    fi

  - if [[ $GR_REBUILD_REFERENCE == "all" ]] || [[ -z "$GR_REBUILD_REFERENCE" ]]; then
      gr_test --create=REFERENCE c ;
    else
    gr_test --create=REFERENCE --filter ${GR_REBUILD_REFERENCE} -- c ;
    fi
  - git config user.name "GR-Test Reference Bot"
  - git config user.email "$GITLAB_USER_EMAIL"
  - git status
  - git add -A gr_test/c_data/
  - git commit -m "Rebuilt c images in build job $CI_JOB_ID"
  - 'git push -o merge_request.description="Job initiator: @$GITLAB_USER_LOGIN" -o merge_request.label="auto-create" -o merge_request.label="reference-files-update" -o merge_request.remove_source_branch -o merge_request.create origin update-files/job-$CI_JOB_ID'

ubuntu-cmake-self-contained-rebuild-images-cpp:
  stage: test
  image: iffregistry.fz-juelich.de/scientific-it-systems/gr-test/cpp-testing:latest
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
      when: never
    - if: '$CI_COMMIT_MESSAGE =~ /RebuildReferenceImages\([][ ?*_a-zA-Z0-9-]*\)/'
      when: on_success
    - if: '$GR_REBUILD_REFERENCE'
      when: on_success
  needs:
    - ubuntu-cmake-self-contained-debug
  script:
    - apt-get update && apt-get install -y python3-venv
    - export GRDIR=`pwd`/artifacts-ubuntu2004-cmake/

    - mkdir -p ~/.ssh
    - cat $SSH_KEY | base64 -d > ~/.ssh/id_rsa
    - mv $SSH_KNOWN_HOSTS ~/.ssh/known_hosts
    - chmod 600 ~/.ssh/id_rsa
    - python3 -m venv env && source env/bin/activate
    - git clone gitlab@iffgit.fz-juelich.de:scientific-it-systems/gr-test.git
    - pip install -e gr-test/
    - cd gr-test
    - git checkout -b update-files/job-$CI_JOB_ID

    - if [[ -z "$GR_REBUILD_REFERENCE" ]]; then
      export GR_REBUILD_REFERENCE=`echo $CI_COMMIT_MESSAGE | sed 's/.*RebuildReferenceImages(\([][ ?*_a-zA-Z0-9-]*\)).*/\1/'` ;
      fi

    - if [[ $GR_REBUILD_REFERENCE == "all" ]] || [[ -z "$GR_REBUILD_REFERENCE" ]]; then
      gr_test --create=REFERENCE cpp ;
      else
      gr_test --create=REFERENCE --filter ${GR_REBUILD_REFERENCE} -- cpp ;
      fi
    - git config user.name "GR-Test Reference Bot"
    - git config user.email "$GITLAB_USER_EMAIL"
    - git status
    - git add -A gr_test/cpp_data/
    - git commit -m "Rebuilt cpp images in build job $CI_JOB_ID"
    - 'git push -o merge_request.description="Job initiator: @$GITLAB_USER_LOGIN" -o merge_request.label="auto-create" -o merge_request.label="reference-files-update" -o merge_request.remove_source_branch -o merge_request.create origin update-files/job-$CI_JOB_ID'

ubuntu-cmake-self-contained-rebuild-images-grplot:
  stage: test
  image: iffregistry.fz-juelich.de/scientific-it-systems/gr-test/grplot-testing:latest
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
      when: never
    - if: '$CI_COMMIT_MESSAGE =~ /RebuildReferenceImages\([][ ?*_a-zA-Z0-9-]*\)/'
      when: on_success
    - if: '$GR_REBUILD_REFERENCE'
      when: on_success
  needs:
    - ubuntu-cmake-self-contained-debug
  script:
    - apt-get update && apt-get install -y python3-venv
    - export GRDIR=`pwd`/artifacts-ubuntu2004-cmake/
    - export LD_LIBRARY_PATH=$GRDIR/lib
    - export PATH=$GRDIR/bin/:$PATH

    - mkdir -p ~/.ssh
    - cat $SSH_KEY | base64 -d > ~/.ssh/id_rsa
    - mv $SSH_KNOWN_HOSTS ~/.ssh/known_hosts
    - chmod 600 ~/.ssh/id_rsa
    - python3 -m venv env && source env/bin/activate
    - git clone gitlab@iffgit.fz-juelich.de:scientific-it-systems/gr-test.git
    - pip install -e gr-test/
    - cd gr-test
    - git checkout -b update-files/job-$CI_JOB_ID

    - if [[ -z "$GR_REBUILD_REFERENCE" ]]; then
      export GR_REBUILD_REFERENCE=`echo $CI_COMMIT_MESSAGE | sed 's/.*RebuildReferenceImages(\([][ ?*_a-zA-Z0-9-]*\)).*/\1/'` ;
      fi

    - if [[ $GR_REBUILD_REFERENCE == "all" ]] || [[ -z "$GR_REBUILD_REFERENCE" ]]; then
      xvfb-run --server-args="-screen 0, 1920x1080x24" gr_test --create=REFERENCE grplot ;
      else
      xvfb-run --server-args="-screen 0, 1920x1080x24" gr_test --create=REFERENCE --filter ${GR_REBUILD_REFERENCE} -- grplot ;
      fi
    - git config user.name "GR-Test Reference Bot"
    - git config user.email "$GITLAB_USER_EMAIL"
    - git status
    - git add -A gr_test/grplot_data/
    - git commit -m "Rebuilt grplot images in build job $CI_JOB_ID"
    - 'git push -o merge_request.description="Job initiator: @$GITLAB_USER_LOGIN" -o merge_request.label="auto-create" -o merge_request.label="reference-files-update" -o merge_request.remove_source_branch -o merge_request.create origin update-files/job-$CI_JOB_ID'

ubuntu-cmake-self-contained-test-snoop:
  stage: test
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/ubuntu-self-contained
  rules:
  - if: '$CI_MERGE_REQUEST_ID'
    when: never
  - if: '$CI_COMMIT_MESSAGE =~ /RebuildReferenceImages\([][ ?*_a-zA-Z0-9-]*\)/'
    when: never
  - if: '$GR_REBUILD_REFERENCE'
    when: never
  - when: on_success
  needs:
  - ubuntu-cmake-self-contained-debug
  variables:
    JULIA_VERSION: 1.8.5
  before_script:
  - apt-get update && apt-get install -y curl
  - curl -fLO "https://julialang-s3.julialang.org/bin/linux/x64/${JULIA_VERSION%.*}/julia-${JULIA_VERSION}-linux-x86_64.tar.gz"
  - tar -C/usr/local --strip=1 -xf "julia-${JULIA_VERSION}-linux-x86_64.tar.gz"
  - julia -e "using Pkg; Pkg.add(\"Images\")"
  - julia -e "using Pkg; Pkg.add(name=\"GR\", rev=\"master\")"
  script:
  - export GRDIR=`pwd`/artifacts-ubuntu2004-cmake/
  - export LD_LIBRARY_PATH=`pwd`/artifacts-ubuntu2004-cmake/lib
  - export LIBC_RAND_DIRPATH=`pwd`
  - export GRM_SNOOP_EXECUTABLE_PATH=`pwd`/grm_snoop
  - export GRM_VALIDATE=yes
  - lib/grm/test/public_api/grm/snoop/compare_grm_julia.sh || {
      mv lib/grm/test/public_api/grm/snoop/diff_images ./;
      exit 1;
    }
  artifacts:
    paths:
    - diff_images
    when: on_failure


ubuntu-system-dependencies:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/$CI_JOB_NAME
  script:
  - make install GRDIR=/usr/local/gr

ubuntu-cmake-system-dependencies:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/ubuntu-system-dependencies
  script:
    - apt-get update
    - apt-get install -y libqhull-dev libbz2-dev libjpeg-turbo8-dev libavdevice-dev libtheora-dev libogg-dev libvpx-dev libfreetype6-dev
    - wget https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-linux-x86_64.tar.gz
    - tar xf cmake-3.23.0-linux-x86_64.tar.gz
    - export CMAKE_CMD=`pwd`/cmake-3.23.0-linux-x86_64/bin/cmake
    - $CMAKE_CMD -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=${CI_PROJECT_DIR}/install -DGR_USE_BUNDLED_LIBRARIES=OFF
    - $CMAKE_CMD --build build

debian-self-contained:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/$CI_JOB_NAME
  script:
  - wget https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-linux-x86_64.tar.gz
  - tar xf cmake-3.23.0-linux-x86_64.tar.gz
  - export CMAKE_CMD=`pwd`/cmake-3.23.0-linux-x86_64/bin/cmake
  - make self GRDIR=/usr/local/gr
  - mkdir artifacts
  - cp lib/gks/demo artifacts/gksdemo
  - cp lib/gks/qt/gksqt artifacts/gksqt
  - cp lib/grm/grplot/grplot artifacts/grplot
  - cp lib/grm/grplot/README.md artifacts/grplot.man.md
  - cp lib/gr/demo artifacts/grdemo
  - cp lib/gks/libGKS.so lib/gks/libGKS.a lib/gks/plugin/*.so lib/gr/libGR.so lib/gr/libGR.a lib/gr3/libGR3.so
       lib/gr3/libGR3platform.so lib/grm/libGRM.a lib/grm/libGRM.so lib/gr/qtgr/*.so artifacts/
  - cp -r lib/gks/fonts artifacts/
  - mkdir artifacts/include/
  - cp lib/gks/gks.h lib/gr/gr.h lib/gr3/gr3.h lib/grm/include/grm.h lib/gr/qtgr/grwidget.h artifacts/include/
  - cp -r lib/grm/include/grm artifacts/include/
  - mv artifacts artifacts-debian10
  artifacts:
    expire_in: 1 week
    paths:
    - artifacts-debian10/

debian-cmake-self-contained:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/debian-self-contained
  script:
    - wget https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-linux-x86_64.tar.gz
    - tar xf cmake-3.23.0-linux-x86_64.tar.gz
    - export CMAKE_CMD=`pwd`/cmake-3.23.0-linux-x86_64/bin/cmake
    - $CMAKE_CMD -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=${CI_PROJECT_DIR}/install -DGR_USE_BUNDLED_LIBRARIES=ON -DGR_BUILD_EXTRA_BUNDLED_LIBRARIES=ON
    - $CMAKE_CMD --build build
    - $CMAKE_CMD --install build
    - mv install artifacts-debian10-cmake
  artifacts:
    expire_in: 1 week
    paths:
      - artifacts-debian10-cmake/

debian-self-contained-armhf:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/$CI_JOB_NAME-cross
  script:
    - make -C 3rdparty default extras \
      HOST=arm-linux-gnueabihf \
      ARCHITECTURE=arm \
      OS=arm-linux-gnueabihf \
      CC=arm-linux-gnueabihf-gcc \
      CXX=arm-linux-gnueabihf-g++ \
      AR=arm-linux-gnueabihf-ar \
      STRIP=arm-linux-gnueabihf-strip \
      PNG_EXTRA_CFLAGS="-DPNG_ARM_NEON_OPT=0" \
      GLFW_EXTRA_CMAKE_FLAGS=-DCMAKE_TOOLCHAIN_FILE=`pwd`/cmake/armhf-linux-gnu.cmake \
      OGG_EXTRA_CONFIGURE_FLAGS=--host=arm-linux-gnueabihf \
      THEORA_EXTRA_CONFIGURE_FLAGS="--host=arm-linux --disable-asm" \
      FFMPEG_EXTRA_CONFIGURE_FLAGS="--cross-prefix=arm-linux-gnueabihf- --arch=armhf --target-os=linux --pkg-config=pkg-config" \
      PIXMAN_EXTRA_CONFIGURE_FLAGS=--host=arm-linux-gnueabihf \
      CAIRO_EXTRA_CONFIGURE_FLAGS=--host=arm-linux-gnueabihfnu \
      TIFF_EXTRA_CONFIGURE_FLAGS=--host=arm-linux-gnueabihf \
      OPENH264_EXTRA_MAKE_FLAGS="OS=linux ARCH=armhf" \
      ZEROMQ_EXTRA_CONFIGURE_FLAGS=--host=arm-linux-gnueabihf \
      LIBXML2_EXTRA_CONFIGURE_FLAGS=--host=arm-linux-gnueabihf
    - make self \
      CC=arm-linux-gnueabihf-gcc \
      LD=arm-linux-gnueabihf-ld \
      AR=arm-linux-gnueabihf-ar \
      CXX=arm-linux-gnueabihf-g++ \
      LINK=arm-linux-gnueabihf-g++ \
      QT_ARCH=armhf \
      QT4_QMAKE=/usr/lib/arm-linux-gnueabihf/qt4/bin/qmake \
      QT5_QMAKE=/usr/lib/arm-linux-gnueabihf/qt5/bin/qmake \
      GRDIR=/usr/local/gr
    - mkdir artifacts
    - cp lib/gks/demo artifacts/gksdemo
    - cp lib/gks/qt/gksqt artifacts/gksqt
    - cp lib/grm/grplot/grplot artifacts/grplot
    - cp lib/grm/grplot/README.md artifacts/grplot.man.md
    - cp lib/gr/demo artifacts/grdemo
    - cp lib/gks/libGKS.so lib/gks/libGKS.a lib/gks/plugin/*.so lib/gr/libGR.so lib/gr/libGR.a lib/gr3/libGR3.so
         lib/gr3/libGR3platform.so lib/grm/libGRM.a lib/grm/libGRM.so lib/gr/qtgr/*.so artifacts/
    - cp -r lib/gks/fonts artifacts/
    - mkdir artifacts/include/
    - cp lib/gks/gks.h lib/gr/gr.h lib/gr3/gr3.h lib/grm/include/grm.h lib/gr/qtgr/grwidget.h artifacts/include/
    - cp -r lib/grm/include/grm artifacts/include/
    - mv artifacts artifacts-debian10-armhf
  artifacts:
    expire_in: 1 week
    paths:
      - artifacts-debian10-armhf/

debian-self-contained-aarch64:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/debian-self-contained-aarch64
  script:
    - make -C 3rdparty default extras \
      HOST=aarch64-linux-gnu \
      ARCHITECTURE=aarch64 \
      OS=aarch64-linux-gnu \
      CC=aarch64-linux-gnu-gcc \
      CXX=aarch64-linux-gnu-g++ \
      AR=aarch64-linux-gnu-ar \
      STRIP=aarch64-linux-gnu-strip \
      PNG_EXTRA_CFLAGS="-DPNG_ARM_NEON_OPT=0" \
      GLFW_EXTRA_CMAKE_FLAGS=-DCMAKE_TOOLCHAIN_FILE=`pwd`/cmake/aarch64-linux-gnu.cmake \
      OGG_EXTRA_CONFIGURE_FLAGS=--host=aarch64-linux-gnu \
      THEORA_EXTRA_CONFIGURE_FLAGS="--host=arm-linux --disable-asm" \
      FFMPEG_EXTRA_CONFIGURE_FLAGS="--cross-prefix=aarch64-linux-gnu- --arch=aarch64 --target-os=linux --pkg-config=pkg-config" \
      PIXMAN_EXTRA_CONFIGURE_FLAGS=--host=aarch64-linux-gnu \
      CAIRO_EXTRA_CONFIGURE_FLAGS=--host=aarch64-linux-gnu \
      TIFF_EXTRA_CONFIGURE_FLAGS=--host=aarch64-linux-gnu \
      OPENH264_EXTRA_MAKE_FLAGS="OS=linux ARCH=aarch64" \
      ZEROMQ_EXTRA_CONFIGURE_FLAGS=--host=aarch64-linux-gnu \
      LIBXML2_EXTRA_CONFIGURE_FLAGS=--host=aarch64-linux-gnu
    - make self \
      CC=aarch64-linux-gnu-gcc \
      LD=aarch64-linux-gnu-ld \
      AR=aarch64-linux-gnu-ar \
      CXX=aarch64-linux-gnu-g++ \
      LINK=aarch64-linux-gnu-g++ \
      QT_ARCH=aarch64 \
      QMAKE=/usr/lib/aarch64-linux-gnu/qt5/bin/qmake \
      GRDIR=/usr/local/gr
    - mkdir artifacts
    - cp lib/gks/demo artifacts/gksdemo
    - cp lib/gks/qt/gksqt artifacts/gksqt
    - cp lib/grm/grplot/grplot artifacts/grplot
    - cp lib/grm/grplot/README.md artifacts/grplot.man.md
    - cp lib/gr/demo artifacts/grdemo
    - cp lib/gks/libGKS.so lib/gks/libGKS.a lib/gks/plugin/*.so lib/gr/libGR.so lib/gr/libGR.a lib/gr3/libGR3.so
      lib/gr3/libGR3platform.so lib/grm/libGRM.a lib/grm/libGRM.so lib/gr/qtgr/*.so artifacts/
    - cp -r lib/gks/fonts artifacts/
    - mkdir artifacts/include/
    - cp lib/gks/gks.h lib/gr/gr.h lib/gr3/gr3.h lib/grm/include/grm.h lib/gr/qtgr/grwidget.h artifacts/include/
    - cp -r lib/grm/include/grm artifacts/include/
    - mv artifacts artifacts-debian10-aarch64
  artifacts:
    expire_in: 1 week
    paths:
      - artifacts-debian10-aarch64/

debian-cmake-self-contained-aarch64:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/debian-self-contained-aarch64
  script:
    - make -C 3rdparty default extras \
      HOST=aarch64-linux-gnu \
      ARCHITECTURE=aarch64 \
      OS=aarch64-linux-gnu \
      CC=aarch64-linux-gnu-gcc \
      CXX=aarch64-linux-gnu-g++ \
      AR=aarch64-linux-gnu-ar \
      STRIP=aarch64-linux-gnu-strip \
      PNG_EXTRA_CFLAGS="-DPNG_ARM_NEON_OPT=0" \
      GLFW_EXTRA_CMAKE_FLAGS=-DCMAKE_TOOLCHAIN_FILE=`pwd`/cmake/aarch64-linux-gnu.cmake \
      OGG_EXTRA_CONFIGURE_FLAGS=--host=aarch64-linux-gnu \
      THEORA_EXTRA_CONFIGURE_FLAGS="--host=arm-linux --disable-asm" \
      FFMPEG_EXTRA_CONFIGURE_FLAGS="--cross-prefix=aarch64-linux-gnu- --arch=aarch64 --target-os=linux --pkg-config=pkg-config" \
      PIXMAN_EXTRA_CONFIGURE_FLAGS=--host=aarch64-linux-gnu \
      CAIRO_EXTRA_CONFIGURE_FLAGS=--host=aarch64-linux-gnu \
      TIFF_EXTRA_CONFIGURE_FLAGS=--host=aarch64-linux-gnu \
      OPENH264_EXTRA_MAKE_FLAGS="OS=linux ARCH=aarch64" \
      ZEROMQ_EXTRA_CONFIGURE_FLAGS=--host=aarch64-linux-gnu \
      LIBXML2_EXTRA_CONFIGURE_FLAGS=--host=aarch64-linux-gnu
    - wget https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-linux-x86_64.tar.gz
    - tar xf cmake-3.23.0-linux-x86_64.tar.gz
    - export CMAKE_CMD=`pwd`/cmake-3.23.0-linux-x86_64/bin/cmake
    - $CMAKE_CMD -S . -B build -DCMAKE_INSTALL_PREFIX=/usr/local/gr -DCMAKE_TOOLCHAIN_FILE=../cmake/aarch64-linux-gnu.cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=$(cd ../3rdparty/build && pwd)
    - $CMAKE_CMD --build build
    - $CMAKE_CMD --install build
    - mv /usr/local/gr ${CI_PROJECT_DIR}/artifacts-debian10-cmake-aarch64
  artifacts:
    expire_in: 1 week
    paths:
      - artifacts-debian10-cmake-aarch64/

debian-cmake-self-contained-armhf:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/debian-self-contained-armhf-cross
  script:
    - make -C 3rdparty default extras \
      HOST=arm-linux-gnueabihf \
      ARCHITECTURE=armhf \
      OS=arm-linux-gnueabihf \
      CC=arm-linux-gnueabihf-gcc \
      CXX=arm-linux-gnueabihf-g++ \
      AR=arm-linux-gnueabihf-ar \
      STRIP=arm-linux-gnueabihf-strip \
      PNG_EXTRA_CFLAGS="-DPNG_ARM_NEON_OPT=0" \
      GLFW_EXTRA_CMAKE_FLAGS=-DCMAKE_TOOLCHAIN_FILE=`pwd`/cmake/armhf-linux-gnu.cmake \
      OGG_EXTRA_CONFIGURE_FLAGS=--host=arm-linux-gnueabihf \
      THEORA_EXTRA_CONFIGURE_FLAGS="--host=arm-linux --disable-asm" \
      FFMPEG_EXTRA_CONFIGURE_FLAGS="--cross-prefix=arm-linux-gnueabihf- --arch=armhf --target-os=linux --pkg-config=pkg-config" \
      PIXMAN_EXTRA_CONFIGURE_FLAGS=--host=arm-linux-gnueabihf \
      CAIRO_EXTRA_CONFIGURE_FLAGS=--host=arm-linux-gnueabihf \
      TIFF_EXTRA_CONFIGURE_FLAGS=--host=arm-linux-gnueabihf \
      OPENH264_EXTRA_MAKE_FLAGS="OS=linux ARCH=armhf" \
      ZEROMQ_EXTRA_CONFIGURE_FLAGS=--host=arm-linux-gnueabihf \
      LIBXML2_EXTRA_CONFIGURE_FLAGS=--host=arm-linux-gnueabihf
    - wget https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-linux-x86_64.tar.gz
    - tar xf cmake-3.23.0-linux-x86_64.tar.gz
    - export CMAKE_CMD=`pwd`/cmake-3.23.0-linux-x86_64/bin/cmake
    - $CMAKE_CMD -S . -B build -DCMAKE_INSTALL_PREFIX=/usr/local/gr -DCMAKE_TOOLCHAIN_FILE=../cmake/armhf-linux-gnu.cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=$(cd ../3rdparty/build && pwd)
    - $CMAKE_CMD --build build
    - $CMAKE_CMD --install build
    - mv /usr/local/gr ${CI_PROJECT_DIR}/artifacts-debian10-cmake-armhf
  artifacts:
    expire_in: 1 week
    paths:
      - artifacts-debian10-cmake-armhf/

debian-system-dependencies:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/$CI_JOB_NAME
  script:
  - make install GRDIR=/usr/local/gr

debian-system-dependencies-armhf:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/$CI_JOB_NAME-cross
  script:
    - make install \
      CC=arm-linux-gnueabihf-gcc \
      LD=arm-linux-gnueabihf-ld \
      AR=arm-linux-gnueabihf-ar \
      CXX=arm-linux-gnueabihf-g++ \
      LINK=arm-linux-gnueabihf-g++ \
      QT_ARCH=armhf \
      QT4_QMAKE=/usr/lib/arm-linux-gnueabihf/qt4/bin/qmake \
      QT5_QMAKE=/usr/lib/arm-linux-gnueabihf/qt5/bin/qmake \
      GRDIR=/usr/local/gr

debian-cmake-system-dependencies:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/debian-system-dependencies
  script:
    - apt-get update
    - apt-get install -y libqhull-dev libbz2-dev libfreetype6-dev
    - wget https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-linux-x86_64.tar.gz
    - tar xf cmake-3.23.0-linux-x86_64.tar.gz
    - export CMAKE_CMD=`pwd`/cmake-3.23.0-linux-x86_64/bin/cmake
    - $CMAKE_CMD -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=${CI_PROJECT_DIR}/install -DGR_USE_BUNDLED_LIBRARIES=OFF
    - $CMAKE_CMD --build build

centos7-self-contained:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/$CI_JOB_NAME
  script:
  - source /opt/rh/devtoolset-8/enable
  - curl -LO https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-linux-x86_64.tar.gz
  - tar xf cmake-3.23.0-linux-x86_64.tar.gz
  - export CMAKE_CMD=`pwd`/cmake-3.23.0-linux-x86_64/bin/cmake
  - make self GRDIR=/usr/local/gr
  - mkdir artifacts
  - cp lib/gks/demo artifacts/gksdemo
  - cp lib/gks/qt/gksqt artifacts/gksqt
  - cp lib/grm/grplot/grplot artifacts/grplot
  - cp lib/grm/grplot/README.md artifacts/grplot.man.md
  - cp lib/gr/demo artifacts/grdemo
  - cp lib/gks/libGKS.so lib/gks/libGKS.a lib/gks/plugin/*.so lib/gr/libGR.so lib/gr/libGR.a lib/gr3/libGR3.so
       lib/gr3/libGR3platform.so lib/grm/libGRM.a lib/grm/libGRM.so lib/gr/qtgr/*.so artifacts/
  - cp -r lib/gks/fonts artifacts/
  - mkdir artifacts/include/
  - cp lib/gks/gks.h lib/gr/gr.h lib/gr3/gr3.h lib/grm/include/grm.h lib/gr/qtgr/grwidget.h artifacts/include/
  - cp -r lib/grm/include/grm artifacts/include/
  - mv artifacts artifacts-centos7
  artifacts:
    expire_in: 1 week
    paths:
    - artifacts-centos7/

centos7-cmake-self-contained:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/centos7-self-contained
  script:
    - source /opt/rh/devtoolset-8/enable
    - curl -LO https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-linux-x86_64.tar.gz
    - tar xf cmake-3.23.0-linux-x86_64.tar.gz
    - export CMAKE_CMD=`pwd`/cmake-3.23.0-linux-x86_64/bin/cmake
    - $CMAKE_CMD -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=${CI_PROJECT_DIR}/install -DGR_USE_BUNDLED_LIBRARIES=ON -DGR_BUILD_EXTRA_BUNDLED_LIBRARIES=ON
    - $CMAKE_CMD --build build
    - $CMAKE_CMD --install build
    - mv install/lib64/ install/lib/
    - mv install artifacts-centos7-cmake
  artifacts:
    expire_in: 1 week
    paths:
      - artifacts-centos7-cmake/

centos7-system-dependencies:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/$CI_JOB_NAME
  script:
  - source /opt/rh/devtoolset-8/enable
  - make install GRDIR=/usr/local/gr

centos7-cmake-system-dependencies:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/centos7-system-dependencies
  script:
    - source /opt/rh/devtoolset-8/enable
    - yum install -y libjpeg-turbo-devel libtiff-devel bzip2-devel
    - curl -LO https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-linux-x86_64.tar.gz
    - tar xf cmake-3.23.0-linux-x86_64.tar.gz
    - export CMAKE_CMD=`pwd`/cmake-3.23.0-linux-x86_64/bin/cmake
    - make -C 3rdparty default TARGETS="qhull"
    - $CMAKE_CMD -S . -B build .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=${CI_PROJECT_DIR}/install -DCMAKE_PREFIX_PATH=$(cd ../3rdparty/build && pwd)
    - $CMAKE_CMD --build build

centos7-32bit-self-contained:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/$CI_JOB_NAME
  script:
  - source /opt/gcc-8.5.0/enable
  - curl -LO https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-linux-i386.tar.gz
  - tar xf cmake-3.23.0-linux-i386.tar.gz
  - export CMAKE_CMD=`pwd`/cmake-3.23.0-linux-i386/bin/cmake
  - THEORA_EXTRA_CONFIGURE_FLAGS=--disable-asm
    OPENH264_EXTRA_MAKE_FLAGS=ARCH=i386
    EXTRA_LDFLAGS="-static-libstdc++ -static-libgcc"
    make self GRDIR=/usr/local/gr
  - mkdir artifacts
  - cp lib/gks/demo artifacts/gksdemo
  - cp lib/gks/qt/gksqt artifacts/gksqt
  - cp lib/grm/grplot/grplot artifacts/grplot
  - cp lib/grm/grplot/README.md artifacts/grplot.man.md
  - cp lib/gr/demo artifacts/grdemo
  - cp lib/gks/libGKS.so lib/gks/libGKS.a lib/gks/plugin/*.so lib/gr/libGR.so lib/gr/libGR.a lib/gr3/libGR3.so
       lib/gr3/libGR3platform.so lib/grm/libGRM.a lib/grm/libGRM.so lib/gr/qtgr/*.so artifacts/
  - cp -r lib/gks/fonts artifacts/
  - mkdir artifacts/include/
  - cp lib/gks/gks.h lib/gr/gr.h lib/gr3/gr3.h lib/grm/include/grm.h lib/gr/qtgr/grwidget.h artifacts/include/
  - cp -r lib/grm/include/grm artifacts/include/
  - mv artifacts artifacts-centos7-32bit
  artifacts:
    expire_in: 1 week
    paths:
    - artifacts-centos7-32bit/

centos7-32bit-cmake-self-contained:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/centos7-32bit-self-contained
  script:
    - source /opt/gcc-8.5.0/enable
    - curl -LO https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-linux-i386.tar.gz
    - tar xf cmake-3.23.0-linux-i386.tar.gz
    - export CMAKE_CMD=`pwd`/cmake-3.23.0-linux-i386/bin/cmake
    - THEORA_EXTRA_CONFIGURE_FLAGS=--disable-asm
      OPENH264_EXTRA_MAKE_FLAGS=ARCH=i386
      make -C 3rdparty default extras
    - LDFLAGS="-static-libstdc++ -static-libgcc"
      $CMAKE_CMD -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=${CI_PROJECT_DIR}/install -DCMAKE_PREFIX_PATH=$(cd ../3rdparty/build && pwd)
    - $CMAKE_CMD --build build
    - $CMAKE_CMD --install build
    - mv install artifacts-centos7-32bit-cmake
  artifacts:
    expire_in: 1 week
    paths:
      - artifacts-centos7-32bit-cmake/

centos7-32bit-system-dependencies:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/$CI_JOB_NAME
  script:
  - source /opt/gcc-8.5.0/enable
  - EXTRA_LDFLAGS="-static-libstdc++ -static-libgcc"
    make install GRDIR=/usr/local/gr

centos7-32bit-cmake-system-dependencies:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/centos7-32bit-system-dependencies
  script:
    - source /opt/gcc-8.5.0/enable
    - yum install -y libtiff-devel bzip2-devel
    - curl -LO https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-linux-i386.tar.gz
    - tar xf cmake-3.23.0-linux-i386.tar.gz
    - export CMAKE_CMD=`pwd`/cmake-3.23.0-linux-i386/bin/cmake
    - make -C 3rdparty default TARGETS="qhull"
    - LDFLAGS="-static-libstdc++ -static-libgcc"
      $CMAKE_CMD -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=${CI_PROJECT_DIR}/install -DCMAKE_FIND_ROOT_PATH=$(cd ../3rdparty/build && pwd)
    - $CMAKE_CMD --build build

arch-self-contained:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/$CI_JOB_NAME
  script:
    - make self GRDIR=/usr/local/gr
    - mkdir artifacts
    - cp lib/gks/demo artifacts/gksdemo
    - cp lib/gks/qt/gksqt artifacts/gksqt
    - cp lib/grm/grplot/grplot artifacts/grplot
    - cp lib/grm/grplot/README.md artifacts/grplot.man.md
    - cp lib/gr/demo artifacts/grdemo
    - cp lib/gks/libGKS.so lib/gks/libGKS.a lib/gks/plugin/*.so lib/gr/libGR.so lib/gr/libGR.a lib/gr3/libGR3.so
         lib/gr3/libGR3platform.so lib/grm/libGRM.a lib/grm/libGRM.so lib/gr/qtgr/*.so artifacts/
    - cp -r lib/gks/fonts artifacts/
    - mkdir artifacts/include/
    - cp lib/gks/gks.h lib/gr/gr.h lib/gr3/gr3.h lib/grm/include/grm.h lib/gr/qtgr/grwidget.h artifacts/include/
    - cp -r lib/grm/include/grm artifacts/include/
    - mv artifacts artifacts-arch
  artifacts:
    expire_in: 1 week
    paths:
      - artifacts-arch/

arch-cmake-self-contained:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/arch-self-contained
  script:
    - cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=${CI_PROJECT_DIR}/install -DGR_USE_BUNDLED_LIBRARIES=ON -DGR_BUILD_EXTRA_BUNDLED_LIBRARIES=ON -DCMAKE_INSTALL_LIBDIR=${CI_PROJECT_DIR}/install/lib
    - cmake --build build
    - cmake --install build
    - mv install artifacts-arch-cmake
  artifacts:
    expire_in: 1 week
    paths:
      - artifacts-arch-cmake/

arch-system-dependencies:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/$CI_JOB_NAME
  script:
    - make install GRDIR=/usr/local/gr

arch-cmake-system-dependencies:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/arch-system-dependencies
  script:
    - pacman -Sy
    - pacman -S --noconfirm --needed qhull
    - cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=${CI_PROJECT_DIR}/install -DGR_USE_BUNDLED_LIBRARIES=OFF
    - cmake --build build

freebsd-self-contained:
  stage: build
  image: freebsd:13-gr-build
  tags:
  - libvirt
  script:
  - sudo mkdir /usr/local/gr
  - sudo chown administrator:administrator /usr/local/gr
  - export CPATH="/usr/local/include"
  - export LIBRARY_PATH="/usr/local/lib"
  - gmake self GRDIR=/usr/local/gr MAKE=gmake
  - mkdir artifacts
  - cp lib/gks/demo artifacts/gksdemo
  - cp lib/gks/qt/gksqt artifacts/gksqt
  - cp lib/grm/grplot/grplot artifacts/grplot
  - cp lib/grm/grplot/README.md artifacts/grplot.man.md
  - cp lib/gr/demo artifacts/grdemo
  - cp lib/gks/libGKS.so lib/gks/libGKS.a lib/gks/plugin/*.so lib/gr/libGR.so lib/gr/libGR.a lib/gr3/libGR3.so
       lib/gr3/libGR3platform.so lib/grm/libGRM.a lib/grm/libGRM.so lib/gr/qtgr/*.so artifacts/
  - cp -r lib/gks/fonts artifacts/
  - mkdir artifacts/include/
  - cp lib/gks/gks.h lib/gr/gr.h lib/gr3/gr3.h lib/grm/include/grm.h lib/gr/qtgr/grwidget.h artifacts/include/
  - cp -r lib/grm/include/grm artifacts/include/
  - mv artifacts artifacts-freebsd13
  artifacts:
    expire_in: 1 week
    paths:
    - artifacts-freebsd13/

windows-32bit-cross:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/$CI_JOB_NAME
  script:
  - wget https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-linux-x86_64.tar.gz
  - tar xf cmake-3.23.0-linux-x86_64.tar.gz
  - export CMAKE_CMD=`pwd`/cmake-3.23.0-linux-x86_64/bin/cmake
  - make -C 3rdparty default extras
    EXTRAS="tiff ogg theora vpx ffmpeg pixman cairo agg libxml2"
    HOST=i686-w64-mingw32
    ARCHITECTURE=i686
    OS=w64_x86-cross-mingw32
    CC=i686-w64-mingw32-gcc
    CXX=i686-w64-mingw32-g++
    AR=i686-w64-mingw32-ar
    GLFW_EXTRA_CMAKE_FLAGS=-DCMAKE_TOOLCHAIN_FILE=`pwd`/cmake/i686-w64-mingw32.cmake
    OGG_EXTRA_CONFIGURE_FLAGS=--host=i686-w64-mingw32
    THEORA_EXTRA_CONFIGURE_FLAGS="--host=i686-w64-mingw32 --disable-asm"
    FFMPEG_EXTRA_CONFIGURE_FLAGS="--cross-prefix=i686-w64-mingw32- --arch=i686 --target-os=mingw32 --pkg-config=pkg-config"
    PIXMAN_EXTRA_CONFIGURE_FLAGS=--host=i686-w64-mingw32
    CAIRO_EXTRA_CONFIGURE_FLAGS=--host=i686-w64-mingw32
    TIFF_EXTRA_CONFIGURE_FLAGS=--host=i686-w64-mingw32
    LIBXML2_EXTRA_CONFIGURE_FLAGS=--host=i686-w64-mingw32
    OPENH264_EXTRA_MAKE_FLAGS="OS=mingw_nt ARCH=i386 CFLAGS=-fno-exceptions CXXFLAGS=-fno-exceptions LDFLAGS=-fno-exceptions"
  - MAKE="make -f makefile.mingw" make -f makefile.mingw
    GRDIR=./
    CC=i686-w64-mingw32-gcc
    CXX=i686-w64-mingw32-g++
    AR=i686-w64-mingw32-ar
    ARCHITECTURE=i686
  - MAKE="make -f makefile.mingw" make -f makefile.mingw -C lib/gks/qt
    GRDIR=./
    CC=i686-w64-mingw32-gcc
    CXX=i686-w64-mingw32-g++
    AR=i686-w64-mingw32-ar
    ARCHITECTURE=i686
  - MAKE="make -f makefile.mingw" make -f makefile.mingw -C lib/grm/grplot
    GRDIR=./
    CC=i686-w64-mingw32-gcc
    CXX=i686-w64-mingw32-g++
    AR=i686-w64-mingw32-ar
    ARCHITECTURE=i686
  - mkdir artifacts
  - cp lib/gks/qt/gksqt.exe artifacts/
  - cp lib/grm/grplot/grplot.exe artifacts/
  - cp lib/grm/grplot/README.md artifacts/grplot.man.md
  - cp lib/gks/qt/*.dll artifacts/
  - cp -r lib/gks/qt/platforms artifacts/
  - cp lib/gks/libGKS.lib lib/gks/libGKS.dll lib/gks/libGKS.a lib/gks/plugin/*.dll lib/gks/plugin/*.a lib/gr/libGR.lib
       lib/gr/libGR.dll lib/gr/libGR.a lib/gr3/libGR3.dll lib/gr3/libGR3.a lib/grm/libGRM.dll lib/grm/libGRM.a
       artifacts/
  - cp -r lib/gks/fonts artifacts/
  - cp /usr/lib/gcc/i686-w64-mingw32/8.3-win32/libgcc_s_sjlj-1.dll artifacts/
  - mkdir artifacts/include/
  - cp lib/gks/gks.h lib/gr/gr.h lib/gr3/gr3.h lib/grm/include/grm.h lib/gr/qtgr/grwidget.h artifacts/include/
  - cp -r lib/grm/include/grm artifacts/include/
  - mv artifacts artifacts-windows32
  artifacts:
    expire_in: 1 week
    paths:
    - artifacts-windows32/

windows-32bit-cmake-cross:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/windows-32bit-cross
  script:
    - mkdir qt5-runtime-Windows-i686
    - cd qt5-runtime-Windows-i686
    - wget https://gr-framework.org/downloads/3rdparty/qt5-runtime-Windows-i686-mingw81.tar.gz
    - tar xf qt5-runtime-Windows-i686-mingw81.tar.gz
    - cd ..
    - wget https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-linux-x86_64.tar.gz
    - tar xf cmake-3.23.0-linux-x86_64.tar.gz
    - export CMAKE_CMD=`pwd`/cmake-3.23.0-linux-x86_64/bin/cmake
    - make -C 3rdparty default extras
      EXTRAS="tiff ogg theora vpx ffmpeg pixman cairo agg libxml2"
      HOST=i686-w64-mingw32
      ARCHITECTURE=i686
      OS=w64_x86-cross-mingw32
      CC=i686-w64-mingw32-gcc
      CXX=i686-w64-mingw32-g++
      AR=i686-w64-mingw32-ar
      OPENJP2_EXTRA_CMAKE_FLAGS=-DCMAKE_TOOLCHAIN_FILE=`pwd`/cmake/i686-w64-mingw32.cmake
      GLFW_EXTRA_CMAKE_FLAGS=-DCMAKE_TOOLCHAIN_FILE=`pwd`/cmake/i686-w64-mingw32.cmake
      OGG_EXTRA_CONFIGURE_FLAGS=--host=i686-w64-mingw32
      THEORA_EXTRA_CONFIGURE_FLAGS="--host=i686-w64-mingw32 --disable-asm"
      FFMPEG_EXTRA_CONFIGURE_FLAGS="--cross-prefix=i686-w64-mingw32- --arch=i686 --target-os=mingw32 --pkg-config=pkg-config"
      PIXMAN_EXTRA_CONFIGURE_FLAGS=--host=i686-w64-mingw32
      CAIRO_EXTRA_CONFIGURE_FLAGS=--host=i686-w64-mingw32
      TIFF_EXTRA_CONFIGURE_FLAGS=--host=i686-w64-mingw32
      LIBXML2_EXTRA_CONFIGURE_FLAGS=--host=i686-w64-mingw32
      OPENH264_EXTRA_MAKE_FLAGS="OS=mingw_nt ARCH=i386 CFLAGS=-fno-exceptions CXXFLAGS=-fno-exceptions LDFLAGS=-fno-exceptions"
    - cd 3rdparty/build/lib/cmake/libxml2
    - |-
      patch -N <<'EOF'
      --- libxml2-config.cmake        2023-05-24 10:50:21.099243441 +0000
      +++ libxml2-config.cmake.patched        2023-05-24 10:50:42.289604090 +0000
      @@ -29,7 +29,7 @@
       set(LIBXML2_VERSION_MINOR  10)
       set(LIBXML2_VERSION_MICRO  4)
       set(LIBXML2_VERSION_STRING "2.10.4")
      -set(LIBXML2_DEFINITIONS    " -DLIBXML_STATIC")
      +set(LIBXML2_DEFINITIONS    -DLIBXML_STATIC)
       set(LIBXML2_INSTALL_PREFIX ${_libxml2_rootdir})
       set(LIBXML2_INCLUDE_DIR    ${_libxml2_rootdir}/include/libxml2)
       set(LIBXML2_LIBRARY_DIR    ${_libxml2_rootdir}/lib)
      EOF
    - cd -
    - $CMAKE_CMD -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=${CI_PROJECT_DIR}/install -DCMAKE_TOOLCHAIN_FILE=`pwd`/../cmake/i686-w64-mingw32.cmake -DCMAKE_MODULE_PATH=${CI_PROJECT_DIR}/qt5-runtime-Windows-i686/cmake -DGR_MANUAL_MOC_AND_RCC=ON -DCMAKE_PREFIX_PATH=$(cd ../3rdparty/build && pwd)
    - $CMAKE_CMD --build build
    - $CMAKE_CMD --install build
    - mv qt5-runtime-Windows-i686/*.dll install/bin/
    - mv qt5-runtime-Windows-i686/platforms install/bin/platforms
    - cp /usr/lib/gcc/i686-w64-mingw32/8.3-win32/libgcc_s_sjlj-1.dll install/bin/
    - mv install artifacts-windows-32bit-cmake
  artifacts:
    expire_in: 1 week
    paths:
      - artifacts-windows-32bit-cmake/

windows-64bit-cross:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/$CI_JOB_NAME
  script:
  - wget https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-linux-x86_64.tar.gz
  - tar xf cmake-3.23.0-linux-x86_64.tar.gz
  - export CMAKE_CMD=`pwd`/cmake-3.23.0-linux-x86_64/bin/cmake
  - make -C 3rdparty default extras
    EXTRAS="tiff ogg theora vpx openh264 ffmpeg pixman cairo agg libxml2"
    HOST=x86_64-w64-mingw32
    ARCHITECTURE=x86_64
    OS=w64_amd64-cross-mingw32
    CC=x86_64-w64-mingw32-gcc
    CXX=x86_64-w64-mingw32-g++
    AR=x86_64-w64-mingw32-ar
    GLFW_EXTRA_CMAKE_FLAGS=-DCMAKE_TOOLCHAIN_FILE=`pwd`/cmake/x86_64-w64-mingw32.cmake
    OGG_EXTRA_CONFIGURE_FLAGS=--host=x86_64-w64-mingw32
    THEORA_EXTRA_CONFIGURE_FLAGS=--host=x86_64-w64-mingw32
    FFMPEG_EXTRA_CONFIGURE_FLAGS="--cross-prefix=x86_64-w64-mingw32- --arch=x86_64 --target-os=mingw32 --pkg-config=pkg-config"
    PIXMAN_EXTRA_CONFIGURE_FLAGS=--host=x86_64-w64-mingw32
    CAIRO_EXTRA_CONFIGURE_FLAGS=--host=x86_64-w64-mingw32
    TIFF_EXTRA_CONFIGURE_FLAGS=--host=x86_64-w64-mingw32
    LIBXML2_EXTRA_CONFIGURE_FLAGS=--host=x86_64-w64-mingw32
    OPENH264_EXTRA_MAKE_FLAGS=OS=mingw_nt
  - MAKE="make -f makefile.mingw" make -f makefile.mingw
    GRDIR=./
    CC=x86_64-w64-mingw32-gcc
    CXX=x86_64-w64-mingw32-g++
    AR=x86_64-w64-mingw32-ar
    ARCHITECTURE=x86_64
  - MAKE="make -f makefile.mingw" make -f makefile.mingw -C lib/gks/qt
    GRDIR=./
    CC=x86_64-w64-mingw32-gcc
    CXX=x86_64-w64-mingw32-g++
    AR=x86_64-w64-mingw32-ar
    ARCHITECTURE=x86_64
  - MAKE="make -f makefile.mingw" make -f makefile.mingw -C lib/grm/grplot
    GRDIR=./
    CC=x86_64-w64-mingw32-gcc
    CXX=x86_64-w64-mingw32-g++
    AR=x86_64-w64-mingw32-ar
    ARCHITECTURE=x86_64
  - mkdir artifacts
  - cp lib/gks/qt/gksqt.exe artifacts/
  - cp lib/grm/grplot/grplot.exe artifacts/
  - cp lib/grm/grplot/README.md artifacts/grplot.man.md
  - cp lib/gks/qt/*.dll artifacts/
  - cp -r lib/gks/qt/platforms artifacts/
  - cp lib/gks/libGKS.lib lib/gks/libGKS.dll lib/gks/libGKS.a lib/gks/plugin/*.dll lib/gks/plugin/*.a lib/gr/libGR.lib
       lib/gr/libGR.dll lib/gr/libGR.a lib/gr3/libGR3.dll lib/gr3/libGR3.a lib/grm/libGRM.dll lib/grm/libGRM.a
       artifacts/
  - cp -r lib/gks/fonts artifacts/
  - cp /usr/lib/gcc/x86_64-w64-mingw32/8.3-win32/libgcc_s_seh-1.dll artifacts/
  - mkdir artifacts/include/
  - cp lib/gks/gks.h lib/gr/gr.h lib/gr3/gr3.h lib/grm/include/grm.h lib/gr/qtgr/grwidget.h artifacts/include/
  - cp -r lib/grm/include/grm artifacts/include/
  - mv artifacts artifacts-windows64
  artifacts:
    expire_in: 1 week
    paths:
    - artifacts-windows64/

windows-64bit-cmake-cross:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/windows-64bit-cross
  script:
    - mkdir qt5-runtime-Windows-x86_64
    - cd qt5-runtime-Windows-x86_64
    - wget https://gr-framework.org/downloads/3rdparty/qt5-runtime-Windows-x86_64-mingw81.tar.gz
    - tar xf qt5-runtime-Windows-x86_64-mingw81.tar.gz
    - cd ..
    - wget https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-linux-x86_64.tar.gz
    - tar xf cmake-3.23.0-linux-x86_64.tar.gz
    - export CMAKE_CMD=`pwd`/cmake-3.23.0-linux-x86_64/bin/cmake
    - make -C 3rdparty default extras
      EXTRAS="tiff ogg theora vpx openh264 ffmpeg pixman cairo agg libxml2"
      HOST=x86_64-w64-mingw32
      ARCHITECTURE=x86_64
      OS=w64_amd64-cross-mingw32
      CC=x86_64-w64-mingw32-gcc
      CXX=x86_64-w64-mingw32-g++
      AR=x86_64-w64-mingw32-ar
      OPENJP2_EXTRA_CMAKE_FLAGS=-DCMAKE_TOOLCHAIN_FILE=`pwd`/cmake/x86_64-w64-mingw32.cmake
      GLFW_EXTRA_CMAKE_FLAGS=-DCMAKE_TOOLCHAIN_FILE=`pwd`/cmake/x86_64-w64-mingw32.cmake
      OGG_EXTRA_CONFIGURE_FLAGS=--host=x86_64-w64-mingw32
      THEORA_EXTRA_CONFIGURE_FLAGS=--host=x86_64-w64-mingw32
      FFMPEG_EXTRA_CONFIGURE_FLAGS="--cross-prefix=x86_64-w64-mingw32- --arch=x86_64 --target-os=mingw32 --pkg-config=pkg-config"
      PIXMAN_EXTRA_CONFIGURE_FLAGS=--host=x86_64-w64-mingw32
      CAIRO_EXTRA_CONFIGURE_FLAGS=--host=x86_64-w64-mingw32
      TIFF_EXTRA_CONFIGURE_FLAGS=--host=x86_64-w64-mingw32
      LIBXML2_EXTRA_CONFIGURE_FLAGS=--host=x86_64-w64-mingw32
      OPENH264_EXTRA_MAKE_FLAGS=OS=mingw_nt
    - cd 3rdparty/build/lib/cmake/libxml2
    - |-
      patch -N <<'EOF'
      --- libxml2-config.cmake        2023-05-24 10:50:21.099243441 +0000
      +++ libxml2-config.cmake.patched        2023-05-24 10:50:42.289604090 +0000
      @@ -29,7 +29,7 @@
       set(LIBXML2_VERSION_MINOR  10)
       set(LIBXML2_VERSION_MICRO  4)
       set(LIBXML2_VERSION_STRING "2.10.4")
      -set(LIBXML2_DEFINITIONS    " -DLIBXML_STATIC")
      +set(LIBXML2_DEFINITIONS    -DLIBXML_STATIC)
       set(LIBXML2_INSTALL_PREFIX ${_libxml2_rootdir})
       set(LIBXML2_INCLUDE_DIR    ${_libxml2_rootdir}/include/libxml2)
       set(LIBXML2_LIBRARY_DIR    ${_libxml2_rootdir}/lib)
      EOF
    - cd -
    - $CMAKE_CMD -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=${CI_PROJECT_DIR}/install -DCMAKE_TOOLCHAIN_FILE=`pwd`/../cmake/x86_64-w64-mingw32.cmake -DCMAKE_MODULE_PATH=${CI_PROJECT_DIR}/qt5-runtime-Windows-x86_64/cmake -DGR_MANUAL_MOC_AND_RCC=ON -DCMAKE_PREFIX_PATH=$(cd ../3rdparty/build && pwd)
    - $CMAKE_CMD --build build
    - $CMAKE_CMD --install build
    - mv qt5-runtime-Windows-x86_64/*.dll install/bin/
    - mv qt5-runtime-Windows-x86_64/platforms install/bin/platforms
    - cp /usr/lib/gcc/x86_64-w64-mingw32/8.3-win32/libgcc_s_seh-1.dll install/bin/
    - mv install artifacts-windows-64bit-cmake
  artifacts:
    expire_in: 1 week
    paths:
      - artifacts-windows-64bit-cmake/

windows-64bit-cmake-msvc:
  stage: build
  image: windows:10-gr-build
  tags:
    - libvirt
  script:
    - vcvars_cmd cmake -S . -B build -DCMAKE_INSTALL_PREFIX=/c/gr -DGR_USE_BUNDLED_LIBRARIES=OFF
    - vcvars_cmd cmake --build build --config Release
    - vcvars_cmd cmake --install build --config Release
    - cd /c/Qt/5.15.2/msvc2019_64/bin
    - cp -v Qt5Core.dll Qt5Gui.dll Qt5Widgets.dll Qt5Network.dll /c/gr/bin/
    - cd -
    - cd /c/gr/bin
    - mkdir -p platforms
    - cp -v /c/Qt/5.15.2/msvc2019_64/plugins/platforms/qwindows.dll platforms/
    - cd -
    - cd /c/local/bin
    - cp -v cairo.dll freetype.dll jpeg62.dll libpng16.dll libxml2.dll pixman-1-0.dll qhull_r.dll tiff.dll tiffxx.dll turbojpeg.dll zlib.dll /c/gr/bin/
    - cd -
    - cp -v "/c/Program Files (x86)/Microsoft Visual Studio/2022/BuildTools/VC/Redist/MSVC/14.31.31103/x64/Microsoft.VC143.CRT/vcruntime140.dll" /c/gr/bin/
    - cp -v "/c/Program Files (x86)/Microsoft Visual Studio/2022/BuildTools/VC/Redist/MSVC/14.31.31103/x64/Microsoft.VC143.CRT/vcruntime140_1.dll" /c/gr/bin/
    - cp -v "/c/Program Files (x86)/Microsoft Visual Studio/2022/BuildTools/VC/Redist/MSVC/14.31.31103/x64/Microsoft.VC143.CRT/msvcp140.dll" /c/gr/bin/
    - cp -v "/c/Program Files (x86)/Microsoft Visual Studio/2022/BuildTools/VC/Redist/MSVC/14.31.31103/x64/Microsoft.VC143.CRT/msvcp140_1.dll" /c/gr/bin/
    - mv /c/gr artifacts-windows-64bit-cmake-msvc
  artifacts:
    expire_in: 1 week
    paths:
      - artifacts-windows-64bit-cmake-msvc/

darwin-self-contained-iff1600:
  stage: build
  only:
    - branches@Scientific-IT-Systems/gr
    - tags@Scientific-IT-Systems/gr
  script:
  - curl -LO https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-macos-universal.tar.gz
  - tar xf cmake-3.23.0-macos-universal.tar.gz
  - export CMAKE_CMD=`pwd`/cmake-3.23.0-macos-universal/CMake.app/Contents/bin/cmake
  - export MACOSX_DEPLOYMENT_TARGET=10.15
  - rm -rf /usr/local/gr/*
  - make self GRDIR=/usr/local/gr QMAKE=/usr/local/qt5/bin/qmake QT5_QMAKE=/usr/local/qt5/bin/qmake
  - mkdir artifacts
  - cp lib/gks/demo artifacts/gksdemo
  - cp lib/gr/demo artifacts/grdemo
  - cp lib/gks/libGKS.dylib lib/gks/libGKS.a lib/gks/plugin/*.so lib/gr/libGR.dylib lib/gr/libGR.a lib/gr3/libGR3.dylib
       lib/grm/libGRM.a lib/grm/libGRM.dylib lib/gr/qtgr/*.dylib artifacts/
  - cp -r lib/gks/fonts artifacts/
  - mkdir artifacts/include/
  - cp lib/gks/gks.h lib/gr/gr.h lib/gr3/gr3.h lib/grm/include/grm.h lib/gr/qtgr/grwidget.h artifacts/include/
  - cp -r lib/grm/include/grm artifacts/include/
  - mkdir artifacts/Applications/
  - cp -r lib/gks/quartz/build/Release/GKSTerm.app artifacts/Applications/GKSTerm.app
  - cp -r lib/gks/qt/gksqt.app artifacts/Applications/gksqt.app
  - mkdir -p artifacts/Applications/gksqt.app/Contents/Frameworks
  - mkdir -p artifacts/Applications/gksqt.app/Contents/plugins/platforms
  - cp /usr/local/qt5/plugins/platforms/libqcocoa.dylib artifacts/Applications/gksqt.app/Contents/plugins/platforms
  - cp lib/grm/grplot/README.md artifacts/grplot.man.md
  - cp -r lib/grm/grplot/grplot.app artifacts/Applications/grplot.app
  - mkdir -p artifacts/Applications/grplot.app/Contents/Frameworks
  - mkdir -p artifacts/Applications/grplot.app/Contents/plugins/platforms
  - cp /usr/local/qt5/plugins/platforms/libqcocoa.dylib artifacts/Applications/grplot.app/Contents/plugins/platforms
  - cd artifacts/Applications
  - for BINARY in gksqt.app/Contents/plugins/platforms/libqcocoa.dylib gksqt.app/Contents/MacOS/gksqt; do
      for QT_FRAMEWORK in `otool -L $BINARY | tr '/' '\n' | grep -E 'Qt.*\.framework' | cut -d. -f1`; do
        rsync -a --exclude Headers --exclude *_debug* /usr/local/qt5/lib/$QT_FRAMEWORK.framework gksqt.app/Contents/Frameworks/;
        install_name_tool -change `otool -L $BINARY | grep $QT_FRAMEWORK | cut -d\( -f1` @executable_path/../Frameworks/$QT_FRAMEWORK.framework/Versions/Current/$QT_FRAMEWORK $BINARY;
      done;
    done
  - for BINARY in grplot.app/Contents/plugins/platforms/libqcocoa.dylib grplot.app/Contents/MacOS/grplot; do
      for QT_FRAMEWORK in `otool -L $BINARY | tr '/' '\n' | grep -E 'Qt.*\.framework' | cut -d. -f1`; do
        rsync -a --exclude Headers --exclude *_debug* /usr/local/qt5/lib/$QT_FRAMEWORK.framework grplot.app/Contents/Frameworks/;
        install_name_tool -change `otool -L $BINARY | grep $QT_FRAMEWORK | cut -d\( -f1` @executable_path/../Frameworks/$QT_FRAMEWORK.framework/Versions/Current/$QT_FRAMEWORK $BINARY;
      done;
    done
  - cd ../../
  - mv artifacts artifacts-darwin-iff1600
  tags:
  - macos
  artifacts:
    expire_in: 1 week
    paths:
    - artifacts-darwin-iff1600/

darwin-self-contained:
  stage: build
  image: macos:catalina-gr-build
  tags:
  - libvirt
  script:
  - export MACOSX_DEPLOYMENT_TARGET=10.15
  - sudo mkdir /usr/local/gr
  - sudo chown administrator:wheel /usr/local/gr
  - make self GRDIR=/usr/local/gr QMAKE=/usr/local/qt5/bin/qmake QT5_QMAKE=/usr/local/qt5/bin/qmake QT6_QMAKE=/usr/local/qt6/bin/qmake
  - mkdir artifacts
  - cp lib/gks/demo artifacts/gksdemo
  - cp lib/gr/demo artifacts/grdemo
  - cp lib/gks/libGKS.dylib lib/gks/libGKS.a lib/gks/plugin/*.so lib/gr/libGR.dylib lib/gr/libGR.a lib/gr3/libGR3.dylib
      lib/grm/libGRM.a lib/grm/libGRM.dylib lib/gr/qtgr/*.dylib artifacts/
  - cp -r lib/gks/fonts artifacts/
  - mkdir artifacts/include/
  - cp lib/gks/gks.h lib/gr/gr.h lib/gr3/gr3.h lib/grm/include/grm.h lib/gr/qtgr/grwidget.h artifacts/include/
  - cp -r lib/grm/include/grm artifacts/include/
  - mkdir artifacts/Applications/
  - cp -r lib/gks/quartz/build/Release/GKSTerm.app artifacts/Applications/GKSTerm.app
  - cp -r lib/gks/qt/gksqt.app artifacts/Applications/gksqt.app
  - mkdir -p artifacts/Applications/gksqt.app/Contents/Frameworks
  - mkdir -p artifacts/Applications/gksqt.app/Contents/plugins/platforms
  - cp /usr/local/qt5/plugins/platforms/libqcocoa.dylib artifacts/Applications/gksqt.app/Contents/plugins/platforms
  - cp lib/grm/grplot/README.md artifacts/grplot.man.md
  - cp -r lib/grm/grplot/grplot.app artifacts/Applications/grplot.app
  - mkdir -p artifacts/Applications/grplot.app/Contents/Frameworks
  - mkdir -p artifacts/Applications/grplot.app/Contents/plugins/platforms
  - cp /usr/local/qt5/plugins/platforms/libqcocoa.dylib artifacts/Applications/grplot.app/Contents/plugins/platforms
  - cd artifacts/Applications
  - for BINARY in gksqt.app/Contents/plugins/platforms/libqcocoa.dylib gksqt.app/Contents/MacOS/gksqt; do
      for QT_FRAMEWORK in `otool -L $BINARY | tr '/' '\n' | grep -E 'Qt.*\.framework' | cut -d. -f1`; do
        rsync -a --exclude Headers --exclude *_debug* /usr/local/qt5/lib/$QT_FRAMEWORK.framework gksqt.app/Contents/Frameworks/;
        install_name_tool -change `otool -L $BINARY | grep $QT_FRAMEWORK | cut -d\( -f1` @executable_path/../Frameworks/$QT_FRAMEWORK.framework/Versions/Current/$QT_FRAMEWORK $BINARY;
      done;
    done
  - for BINARY in grplot.app/Contents/plugins/platforms/libqcocoa.dylib grplot.app/Contents/MacOS/grplot; do
      for QT_FRAMEWORK in `otool -L $BINARY | tr '/' '\n' | grep -E 'Qt.*\.framework' | cut -d. -f1`; do
        rsync -a --exclude Headers --exclude *_debug* /usr/local/qt5/lib/$QT_FRAMEWORK.framework grplot.app/Contents/Frameworks/;
        install_name_tool -change `otool -L $BINARY | grep $QT_FRAMEWORK | cut -d\( -f1` @executable_path/../Frameworks/$QT_FRAMEWORK.framework/Versions/Current/$QT_FRAMEWORK $BINARY;
      done;
    done
  - cd ../../
  - mv artifacts artifacts-darwin
  artifacts:
    expire_in: 1 week
    paths:
    - artifacts-darwin/

darwin-self-contained-iff1605:
  stage: build
  only:
    - branches@Scientific-IT-Systems/gr
    - tags@Scientific-IT-Systems/gr
  script:
    - curl -LO https://gr-framework.org/downloads/3rdparty/cmake-3.23.0-macos-universal.tar.gz
    - tar xf cmake-3.23.0-macos-universal.tar.gz
    - export CMAKE_CMD=`pwd`/cmake-3.23.0-macos-universal/CMake.app/Contents/bin/cmake
    - export MACOSX_DEPLOYMENT_TARGET=11.0
    - rm -rf /usr/local/gr/*
    - make self GRDIR=/usr/local/gr QMAKE=/usr/local/qt5/bin/qmake QT5_QMAKE=/usr/local/qt5/bin/qmake
    - mkdir artifacts
    - cp lib/gks/demo artifacts/gksdemo
    - cp lib/gr/demo artifacts/grdemo
    - cp lib/gks/libGKS.dylib lib/gks/libGKS.a lib/gks/plugin/*.so lib/gr/libGR.dylib lib/gr/libGR.a lib/gr3/libGR3.dylib
      lib/grm/libGRM.a lib/grm/libGRM.dylib lib/gr/qtgr/*.dylib artifacts/
    - cp -r lib/gks/fonts artifacts/
    - mkdir artifacts/include/
    - cp lib/gks/gks.h lib/gr/gr.h lib/gr3/gr3.h lib/grm/include/grm.h lib/gr/qtgr/grwidget.h artifacts/include/
    - cp -r lib/grm/include/grm artifacts/include/
    - mkdir artifacts/Applications/
    - cp -r lib/gks/quartz/build/Release/GKSTerm.app artifacts/Applications/GKSTerm.app
    - cp -r lib/gks/qt/gksqt.app artifacts/Applications/gksqt.app
    - mkdir -p artifacts/Applications/gksqt.app/Contents/Frameworks
    - mkdir -p artifacts/Applications/gksqt.app/Contents/plugins/platforms
    - cp /usr/local/qt5/plugins/platforms/libqcocoa.dylib artifacts/Applications/gksqt.app/Contents/plugins/platforms
    - cp lib/grm/grplot/README.md artifacts/grplot.man.md
    - cp -r lib/grm/grplot/grplot.app artifacts/Applications/grplot.app
    - mkdir -p artifacts/Applications/grplot.app/Contents/Frameworks
    - mkdir -p artifacts/Applications/grplot.app/Contents/plugins/platforms
    - cp /usr/local/qt5/plugins/platforms/libqcocoa.dylib artifacts/Applications/grplot.app/Contents/plugins/platforms
    - cd artifacts/Applications
    - for BINARY in gksqt.app/Contents/plugins/platforms/libqcocoa.dylib gksqt.app/Contents/MacOS/gksqt; do
        for QT_FRAMEWORK in `otool -L $BINARY | tr '/' '\n' | grep -E 'Qt.*\.framework' | cut -d. -f1`; do
          rsync -a --exclude Headers --exclude *_debug* /usr/local/qt5/lib/$QT_FRAMEWORK.framework gksqt.app/Contents/Frameworks/;
          install_name_tool -change `otool -L $BINARY | grep $QT_FRAMEWORK | cut -d\( -f1` @executable_path/../Frameworks/$QT_FRAMEWORK.framework/Versions/Current/$QT_FRAMEWORK $BINARY;
        done;
      done
    - for BINARY in grplot.app/Contents/plugins/platforms/libqcocoa.dylib grplot.app/Contents/MacOS/grplot; do
        for QT_FRAMEWORK in `otool -L $BINARY | tr '/' '\n' | grep -E 'Qt.*\.framework' | cut -d. -f1`; do
          rsync -a --exclude Headers --exclude *_debug* /usr/local/qt5/lib/$QT_FRAMEWORK.framework grplot.app/Contents/Frameworks/;
          install_name_tool -change `otool -L $BINARY | grep $QT_FRAMEWORK | cut -d\( -f1` @executable_path/../Frameworks/$QT_FRAMEWORK.framework/Versions/Current/$QT_FRAMEWORK $BINARY;
        done;
      done
    - cd ../../
    - mv artifacts artifacts-darwin-aarch64
  tags:
    - macos-arm64
  artifacts:
    expire_in: 1 week
    paths:
      - artifacts-darwin-aarch64/

emscripten:
  stage: build
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/$CI_JOB_NAME
  script:
  - source /emsdk/emsdk_env.sh
  - emmake make -C js
  - mkdir artifacts
  - cp js/gr.js artifacts/
  - mv artifacts artifacts-js
  artifacts:
    expire_in: 1 week
    paths:
    - artifacts-js/

binary-builder:
  stage: build
  script: noop
  tags:
  - julia-bb
  allow_failure: true
  needs:
  - job: emscripten
    artifacts: true
  only:
  - master@Scientific-IT-Systems/gr
  - develop@Scientific-IT-Systems/gr
  - tags@Scientific-IT-Systems/gr
  variables:
    GIT_STRATEGY: none
    JULIA_VERSION: 1.10.0

packages-tar:
  stage: package
  image: ubuntu:18.04
  variables:
    GIT_STRATEGY: none
  script:
  - mkdir -p Windows-i686/gr/bin
  - mkdir -p Windows-i686/gr/lib
  - mkdir -p Windows-i686/gr/share/doc/grplot
  - mv artifacts-windows32/*.dll Windows-i686/gr/bin/
  - mv artifacts-windows32/*.lib Windows-i686/gr/bin/
  - mv artifacts-windows32/gksqt.exe Windows-i686/gr/bin/
  - mv artifacts-windows32/grplot.exe Windows-i686/gr/bin/
  - mv artifacts-windows32/grplot.man.md Windows-i686/gr/share/doc/grplot/
  - mv artifacts-windows32/platforms Windows-i686/gr/bin/
  - mv artifacts-windows32/fonts Windows-i686/gr/
  - mv artifacts-windows32/include Windows-i686/gr/
  - cp artifacts-js/gr.js Windows-i686/gr/lib/
  - rm -rf artifacts-windows32
  - mkdir -p Windows-x86_64/gr/bin
  - mkdir -p Windows-x86_64/gr/lib
  - mkdir -p Windows-x86_64/gr/share/doc/grplot
  - mv artifacts-windows64/*.dll Windows-x86_64/gr/bin/
  - mv artifacts-windows64/*.lib Windows-x86_64/gr/bin/
  - mv artifacts-windows64/gksqt.exe Windows-x86_64/gr/bin/
  - mv artifacts-windows64/grplot.exe Windows-x86_64/gr/bin/
  - mv artifacts-windows64/grplot.man.md Windows-x86_64/gr/share/doc/grplot/
  - mv artifacts-windows64/platforms Windows-x86_64/gr/bin/
  - mv artifacts-windows64/fonts Windows-x86_64/gr/
  - mv artifacts-windows64/include Windows-x86_64/gr/
  - cp artifacts-js/gr.js Windows-x86_64/gr/lib/
  - rm -rf artifacts-windows64
  - mkdir -p Windows-x86_64-msvc
  - mv artifacts-windows-64bit-cmake-msvc Windows-x86_64-msvc/gr
  - mkdir -p Debian-x86_64/gr/bin
  - mkdir -p Debian-x86_64/gr/lib
  - mkdir -p Debian-x86_64/gr/share/doc/grplot
  - mv artifacts-debian10/*.so Debian-x86_64/gr/lib/
  - mv artifacts-debian10/gksqt Debian-x86_64/gr/bin/
  - mv artifacts-debian10/grplot Debian-x86_64/gr/bin/
  - mv artifacts-debian10/grplot.man.md Debian-x86_64/gr/share/doc/grplot/
  - mv artifacts-debian10/fonts Debian-x86_64/gr/
  - mv artifacts-debian10/include Debian-x86_64/gr/
  - cp artifacts-js/gr.js Debian-x86_64/gr/lib/
  - rm -rf artifacts-debian10
  - mkdir -p Debian-armhf/gr/bin
  - mkdir -p Debian-armhf/gr/lib
  - mkdir -p Debian-armhf/gr/share/doc/grplot
  - mv artifacts-debian10-armhf/*.so Debian-armhf/gr/lib/
  - mv artifacts-debian10-armhf/gksqt Debian-armhf/gr/bin/
  - mv artifacts-debian10-armhf/grplot Debian-armhf/gr/bin/
  - mv artifacts-debian10-armhf/grplot.man.md Debian-armhf/gr/share/doc/grplot/
  - mv artifacts-debian10-armhf/fonts Debian-armhf/gr/
  - mv artifacts-debian10-armhf/include Debian-armhf/gr/
  - cp artifacts-js/gr.js Debian-armhf/gr/lib/
  - rm -rf artifacts-debian10-armhf
  - mkdir -p Debian-aarch64/gr/bin
  - mkdir -p Debian-aarch64/gr/lib
  - mkdir -p Debian-aarch64/gr/share/doc/grplot
  - mv artifacts-debian10-aarch64/*.so Debian-aarch64/gr/lib/
  - mv artifacts-debian10-aarch64/gksqt Debian-aarch64/gr/bin/
  - mv artifacts-debian10-aarch64/grplot Debian-aarch64/gr/bin/
  - mv artifacts-debian10-aarch64/grplot.man.md Debian-aarch64/gr/share/doc/grplot/
  - mv artifacts-debian10-aarch64/fonts Debian-aarch64/gr/
  - mv artifacts-debian10-aarch64/include Debian-aarch64/gr/
  - cp artifacts-js/gr.js Debian-aarch64/gr/lib/
  - rm -rf artifacts-debian10-aarch64
  - mkdir -p Ubuntu-x86_64/gr/bin
  - mkdir -p Ubuntu-x86_64/gr/lib
  - mkdir -p Ubuntu-x86_64/gr/share/doc/grplot
  - mv artifacts-ubuntu2004/*.so Ubuntu-x86_64/gr/lib/
  - mv artifacts-ubuntu2004/gksqt Ubuntu-x86_64/gr/bin/
  - mv artifacts-ubuntu2004/grplot Ubuntu-x86_64/gr/bin/
  - mv artifacts-ubuntu2004/grplot.man.md Ubuntu-x86_64/gr/share/doc/grplot/
  - mv artifacts-ubuntu2004/fonts Ubuntu-x86_64/gr/
  - mv artifacts-ubuntu2004/include Ubuntu-x86_64/gr/
  - cp artifacts-js/gr.js Ubuntu-x86_64/gr/lib/
  - rm -rf artifacts-ubuntu2004
  - mkdir -p CentOS-x86_64/gr/bin
  - mkdir -p CentOS-x86_64/gr/lib
  - mkdir -p CentOS-x86_64/gr/share/doc/grplot
  - mv artifacts-centos7/*.so CentOS-x86_64/gr/lib/
  - mv artifacts-centos7/gksqt CentOS-x86_64/gr/bin/
  - mv artifacts-centos7/grplot CentOS-x86_64/gr/bin/
  - mv artifacts-centos7/grplot.man.md CentOS-x86_64/gr/share/doc/grplot/
  - mv artifacts-centos7/fonts CentOS-x86_64/gr/
  - mv artifacts-centos7/include CentOS-x86_64/gr/
  - cp artifacts-js/gr.js CentOS-x86_64/gr/lib/
  - rm -rf artifacts-centos7
  - cp -r CentOS-x86_64 Linux-x86_64
  - mkdir -p Linux-i386/gr/bin
  - mkdir -p Linux-i386/gr/lib
  - mkdir -p Linux-i386/gr/share/doc/grplot
  - mv artifacts-centos7-32bit/*.so Linux-i386/gr/lib/
  - mv artifacts-centos7-32bit/gksqt Linux-i386/gr/bin/
  - mv artifacts-centos7-32bit/grplot Linux-i386/gr/bin/
  - mv artifacts-centos7-32bit/grplot.man.md Linux-i386/gr/share/doc/grplot/
  - mv artifacts-centos7-32bit/fonts Linux-i386/gr/
  - mv artifacts-centos7-32bit/include Linux-i386/gr/
  - cp artifacts-js/gr.js Linux-i386/gr/lib/
  - rm -rf artifacts-centos7-32bit
  - mkdir -p ArchLinux-x86_64/gr/bin
  - mkdir -p ArchLinux-x86_64/gr/lib
  - mkdir -p ArchLinux-x86_64/gr/share/doc/grplot
  - mv artifacts-arch/*.so ArchLinux-x86_64/gr/lib/
  - mv artifacts-arch/gksqt ArchLinux-x86_64/gr/bin/
  - mv artifacts-arch/grplot ArchLinux-x86_64/gr/bin/
  - mv artifacts-arch/grplot.man.md ArchLinux-x86_64/gr/share/doc/grplot/
  - mv artifacts-arch/fonts ArchLinux-x86_64/gr/
  - mv artifacts-arch/include ArchLinux-x86_64/gr/
  - cp artifacts-js/gr.js ArchLinux-x86_64/gr/lib/
  - rm -rf artifacts-arch
  - mkdir -p FreeBSD-x86_64/gr/bin
  - mkdir -p FreeBSD-x86_64/gr/lib
  - mkdir -p FreeBSD-x86_64/gr/share/doc/grplot
  - mv artifacts-freebsd13/*.so FreeBSD-x86_64/gr/lib/
  - mv artifacts-freebsd13/gksqt FreeBSD-x86_64/gr/bin/
  - mv artifacts-freebsd13/grplot FreeBSD-x86_64/gr/bin/
  - mv artifacts-freebsd13/grplot.man.md FreeBSD-x86_64/gr/share/doc/grplot/
  - mv artifacts-freebsd13/fonts FreeBSD-x86_64/gr/
  - mv artifacts-freebsd13/include FreeBSD-x86_64/gr/
  - cp artifacts-js/gr.js FreeBSD-x86_64/gr/lib/
  - rm -rf artifacts-freebsd13
  - mkdir -p Darwin-x86_64/gr/bin
  - mkdir -p Darwin-x86_64/gr/lib
  - mkdir -p Darwin-x86_64/gr/share/doc/grplot
  - mv artifacts-darwin/grplot.man.md Darwin-x86_64/gr/share/doc/grplot/
  - mv artifacts-darwin/*.dylib Darwin-x86_64/gr/lib/
  - mv artifacts-darwin/*.so Darwin-x86_64/gr/lib/
  - mv artifacts-darwin/fonts Darwin-x86_64/gr/
  - mv artifacts-darwin/include Darwin-x86_64/gr/
  - mv artifacts-darwin/Applications Darwin-x86_64/gr/
  - cp artifacts-js/gr.js Darwin-x86_64/gr/lib/
  - rm -rf artifacts-darwin
  - if [ -d artifacts-darwin-aarch64 ]; then
      mkdir -p Darwin-aarch64/gr/lib;
      mv artifacts-darwin-aarch64/*.dylib Darwin-aarch64/gr/lib/;
      mv artifacts-darwin-aarch64/*.so Darwin-aarch64/gr/lib/;
      mv artifacts-darwin-aarch64/fonts Darwin-aarch64/gr/;
      mv artifacts-darwin-aarch64/include Darwin-aarch64/gr/;
      mv artifacts-darwin-aarch64/Applications Darwin-aarch64/gr/;
      cp artifacts-js/gr.js Darwin-aarch64/gr/lib/;
      rm -rf artifacts-darwin-aarch64;
      cd Darwin-aarch64 && tar czf gr.tar.gz gr && cd -;
    fi
  - cd Darwin-x86_64 && tar czf gr.tar.gz gr && cd -;
  - cd Windows-i686 && tar czf gr.tar.gz gr && cd -
  - cd Windows-x86_64 && tar czf gr.tar.gz gr && cd -
  - cd Windows-x86_64-msvc && tar czf gr.tar.gz gr && cd -
  - cd Debian-x86_64 && tar czf gr.tar.gz gr && cd -
  - cd Debian-armhf && tar czf gr.tar.gz gr && cd -
  - cd Debian-aarch64 && tar czf gr.tar.gz gr && cd -
  - cd Ubuntu-x86_64 && tar czf gr.tar.gz gr && cd -
  - cd CentOS-x86_64 && tar czf gr.tar.gz gr && cd -
  - cd Linux-i386 && tar czf gr.tar.gz gr && cd -
  - cd Linux-x86_64 && tar czf gr.tar.gz gr && cd -
  - cd ArchLinux-x86_64 && tar czf gr.tar.gz gr && cd -
  - cd FreeBSD-x86_64 && tar czf gr.tar.gz gr && cd -
  - mkdir Downloads
  - if echo "$CI_COMMIT_TAG" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
      export VERSION=`echo "$CI_COMMIT_TAG" | sed 's/^v//'`;
      cp Windows-i686/gr.tar.gz Downloads/gr-$VERSION-Windows-i686.tar.gz;
      cp Windows-x86_64/gr.tar.gz Downloads/gr-$VERSION-Windows-x86_64.tar.gz;
      cp Windows-x86_64-msvc/gr.tar.gz Downloads/gr-$VERSION-Windows-x86_64-msvc.tar.gz;
      cp Debian-x86_64/gr.tar.gz Downloads/gr-$VERSION-Debian-x86_64.tar.gz;
      cp Debian-armhf/gr.tar.gz Downloads/gr-$VERSION-Debian-armhf.tar.gz;
      cp Debian-aarch64/gr.tar.gz Downloads/gr-$VERSION-Debian-aarch64.tar.gz;
      cp Ubuntu-x86_64/gr.tar.gz Downloads/gr-$VERSION-Ubuntu-x86_64.tar.gz;
      cp CentOS-x86_64/gr.tar.gz Downloads/gr-$VERSION-CentOS-x86_64.tar.gz;
      ln -s gr-$VERSION-CentOS-x86_64.tar.gz Downloads/gr-$VERSION-Redhat-x86_64.tar.gz;
      cp Linux-i386/gr.tar.gz Downloads/gr-$VERSION-Linux-i386.tar.gz;
      cp Linux-x86_64/gr.tar.gz Downloads/gr-$VERSION-Linux-x86_64.tar.gz;
      cp ArchLinux-x86_64/gr.tar.gz Downloads/gr-$VERSION-ArchLinux-x86_64.tar.gz;
      cp FreeBSD-x86_64/gr.tar.gz Downloads/gr-$VERSION-FreeBSD-x86_64.tar.gz;
      cp Darwin-x86_64/gr.tar.gz Downloads/gr-$VERSION-Darwin-x86_64.tar.gz;
      if [ -d Darwin-aarch64 ]; then
        cp Darwin-aarch64/gr.tar.gz Downloads/gr-$VERSION-Darwin-aarch64.tar.gz;
      fi;
      cp artifacts-js/gr.js Downloads/gr-$VERSION.js;
      cd Downloads && sha512sum -b gr-*.tar.gz > gr-$VERSION.sha512.txt && cd -;
    else
      cp Windows-i686/gr.tar.gz Downloads/gr-$CI_COMMIT_SHA-Windows-i686.tar.gz;
      cp Windows-x86_64/gr.tar.gz Downloads/gr-$CI_COMMIT_SHA-Windows-x86_64.tar.gz;
      cp Windows-x86_64-msvc/gr.tar.gz Downloads/gr-$CI_COMMIT_SHA-Windows-x86_64-msvc.tar.gz;
      cp Debian-x86_64/gr.tar.gz Downloads/gr-$CI_COMMIT_SHA-Debian-x86_64.tar.gz;
      cp Debian-armhf/gr.tar.gz Downloads/gr-$CI_COMMIT_SHA-Debian-armhf.tar.gz;
      cp Debian-aarch64/gr.tar.gz Downloads/gr-$CI_COMMIT_SHA-Debian-aarch64.tar.gz;
      cp Ubuntu-x86_64/gr.tar.gz Downloads/gr-$CI_COMMIT_SHA-Ubuntu-x86_64.tar.gz;
      cp CentOS-x86_64/gr.tar.gz Downloads/gr-$CI_COMMIT_SHA-CentOS-x86_64.tar.gz;
      ln -s gr-$CI_COMMIT_SHA-CentOS-x86_64.tar.gz Downloads/gr-$CI_COMMIT_SHA-Redhat-x86_64.tar.gz;
      cp Linux-i386/gr.tar.gz Downloads/gr-$CI_COMMIT_SHA-Linux-i386.tar.gz;
      cp Linux-x86_64/gr.tar.gz Downloads/gr-$CI_COMMIT_SHA-Linux-x86_64.tar.gz;
      cp ArchLinux-x86_64/gr.tar.gz Downloads/gr-$CI_COMMIT_SHA-ArchLinux-x86_64.tar.gz;
      cp FreeBSD-x86_64/gr.tar.gz Downloads/gr-$CI_COMMIT_SHA-FreeBSD-x86_64.tar.gz;
      cp Darwin-x86_64/gr.tar.gz Downloads/gr-$CI_COMMIT_SHA-Darwin-x86_64.tar.gz;
      if [ -d Darwin-aarch64 ]; then
        cp Darwin-aarch64/gr.tar.gz Downloads/gr-$CI_COMMIT_SHA-Darwin-aarch64.tar.gz;
      fi;
      cp artifacts-js/gr.js Downloads/gr-$CI_COMMIT_SHA.js;
      for f in Windows-i686 Windows-x86_64 Windows-x86_64-msvc Darwin-x86_64 Debian-x86_64 Debian-armhf Debian-aarch64
               Ubuntu-x86_64 CentOS-x86_64 Redhat-x86_64 Linux-i386 Linux-x86_64 ArchLinux-x86_64 FreeBSD-x86_64; do
        ln -s gr-$CI_COMMIT_SHA-$f.tar.gz Downloads/gr-latest-$f.tar.gz;
      done;
      if [ -d Darwin-aarch64 ]; then
        ln -s gr-$CI_COMMIT_SHA-Darwin-aarch64.tar.gz Downloads/gr-latest-Darwin-aarch64.tar.gz;
      fi;
      ln -s gr-$CI_COMMIT_SHA.js Downloads/gr-latest.js;
      cd Downloads && sha512sum -b gr-*.tar.gz > gr-$CI_COMMIT_SHA.sha512.txt && cd -;
      ln -s gr-$CI_COMMIT_SHA.sha512.txt Downloads/gr-latest.sha512.txt;
    fi
  artifacts:
    expire_in: 1 week
    paths:
    - Downloads/

sync:
  stage: sync
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/deploy
  variables:
    GIT_STRATEGY: none
  only:
    - master@Scientific-IT-Systems/gr
    - develop@Scientific-IT-Systems/gr
    - tags@Scientific-IT-Systems/gr
  script:
  - chmod 644 Downloads/*.tar.gz
  - chmod 644 Downloads/*.js
  - python3 -m pip install git+https://gitlab-ci-token:${CI_JOB_TOKEN}@iffgit.fz-juelich.de/Scientific-IT-Systems/github-binary-upload.git
  - mkdir --mode=700 ~/.ssh/
  - (umask 0377 && echo "$SCIAPP_GR_PRIVATE_KEY" > ~/.ssh/id_rsa
                && echo "github.com $GITHUB_HOST_KEY" >> ~/.ssh/known_hosts)
  - git clone --mirror "$CI_REPOSITORY_URL" gr_mirror
  - cd gr_mirror && git push --mirror git@github.com:sciapp/gr.git && cd -
  - set +x
  - sshpass -p $RSYNC_PASSWORD rsync -av ./Downloads/ rsync://$RSYNC_USERNAME@iffweb.iff.kfa-juelich.de/gr/
  - if echo "$CI_COMMIT_TAG" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
      echo "$SCIAPP_GR_ACCESS_TOKEN" | github-binary-upload --user jheinen sciapp/gr "$CI_COMMIT_TAG" Downloads/gr-*;
    fi

deploy-to-obs:
  stage: deploy
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/$CI_JOB_NAME
  only:
    - develop@Scientific-IT-Systems/gr
    - tags@Scientific-IT-Systems/gr
  before_script:
  - export OBS_PROJECT=science\:gr-framework
  - if [[ -z "${CI_COMMIT_TAG}" ]]; then
      export OBS_PROJECT=${OBS_PROJECT}\:unstable;
      export VERSION="$(git describe --long --tags | sed 's/^v//;s/\(.*\)-\(.*\)-g\(.*\)/\1+\2~\3/;')";
      export REVISION=${CI_COMMIT_SHORT_SHA};
    else
      export VERSION=`echo "$CI_COMMIT_TAG" | sed 's/^v//'`;
      export REVISION="tags\/${CI_COMMIT_TAG}";
    fi;
  script:
  - mkdir -p "${HOME}/.config/osc" && ln -s "${OSCRC}" "${HOME}/.config/osc/oscrc"
  - osc co ${OBS_PROJECT}/gr
  - sed 's/\(.*revision">\).*\(<.*\)/\1'$REVISION'\2/'
    ${OBS_PROJECT}/gr/_service |
    sed 's/\(.*version">\)[[:digit:]].*\(<.*\)/\1'$VERSION'\2/'
    > ${OBS_PROJECT}/gr/_service.new &&
    mv -f ${OBS_PROJECT}/gr/_service.new
    ${OBS_PROJECT}/gr/_service
  - osc commit ${OBS_PROJECT}/gr/_service -m "Release $REVISION"

deploy-to-aur:
  stage: deploy
  image: iffregistry.fz-juelich.de/docker-images/gr-build-images/$CI_JOB_NAME
  only:
    - develop@Scientific-IT-Systems/gr
    - tags@Scientific-IT-Systems/gr
  script:
  - git config --global --add safe.directory "$(pwd)"
  - mkdir --mode=700 ~/.ssh/
  - (umask 0377 && echo "$AUR_GR_PRIVATE_KEY" > ~/.ssh/id_rsa
                && echo "aur.archlinux.org $AUR_HOST_KEY" >> ~/.ssh/known_hosts)
  - if [[ -n "${CI_COMMIT_TAG}" ]]; then
      if echo "$CI_COMMIT_TAG" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
        for repo in "gr-framework" "gr-framework-js"; do
          git clone "ssh://aur@aur.archlinux.org/${repo}.git";
          cd "${repo}";
          sed -i -e "/^pkgver=/c\pkgver=\"${CI_COMMIT_TAG#v}\"" -e "/^pkgrel=/c\pkgrel=\"1\"" PKGBUILD;
          (
            source PKGBUILD;
            curl -o source -L "${source[0]}";
            SHA256SUM="$(sha256sum source | awk '{ print $1 }')";
            if [[ "${repo}" == "gr-framework" ]]; then
              sed -i "/^sha256sums=/c\sha256sums=(\"${SHA256SUM}\")" PKGBUILD;
            else
              sed -i "/^sha256sums=/c\sha256sums=(\"${SHA256SUM}\" \\\\" PKGBUILD;
            fi;
          );
          makepkg --printsrcinfo > .SRCINFO;
          if ! git diff --quiet; then
            git commit -a -m "Update to version ${CI_COMMIT_TAG#v}";
            git push;
          else
            echo "No changes to commit.";
          fi;
          cd ..;
        done;
      fi;
    else
      PKGVERS="$(git describe --long --tags | sed 's/^v//;s/\([^-]*-g\)/r\1/;s/-/./g')";
      for repo in "gr-framework-git" "gr-framework-js-git"; do
        git clone "ssh://aur@aur.archlinux.org/${repo}.git";
        cd "${repo}";
        sed -i -e "/^pkgver=/c\pkgver=\"${PKGVERS}\"" -e "/^pkgrel=/c\pkgrel=\"1\"" PKGBUILD;
        makepkg --printsrcinfo > .SRCINFO;
        if ! git diff --quiet; then
          git commit -a -m "Update to version ${PKGVERS}";
          git push;
        else
          echo "No changes to commit.";
        fi;
        cd ..;
      done;
    fi
